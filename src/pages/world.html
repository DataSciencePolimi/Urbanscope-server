<!DOCTYPE html>
<html>
<head>
  <title>Telecom World Map</title>
  <style></style>
  <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="//code.highcharts.com/maps/highmaps.js"></script>
  <script type="text/javascript" src="//code.highcharts.com/mapdata/custom/world-highres.js"></script>
  <script>
    function getData( type, start, end ) {
      var url = this.location.pathname.split( '/' );
      url.pop();;
      url.push( 'total' );

      return $.getJSON( url.join( '/' ), {
        startDate: start,
        endDate: end,
      } )
      .then( function( data ) {
        var calls = data.calls[0];

        return $.map( calls.countries, function( val, key ) {
          return {
            code: key,
            value: val[ type ],
          };
        } )
        .filter( function( v ) {
          return v.code!=='IT' && v.code!=='null';
        } );
      } )
    }

    function drawMap( type, start, end ) {
      getData( type, start, end )
      .then( function(data) {
        $( '#map' ).highcharts( 'Map', {
          title: {
            text: 'Wold'
          },
          mapNavigation: {
            enabled: true
          },
          legend: {
            title: {
              text: 'Calls',
              style: {
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'black'
              }
            },
            align: 'left',
            verticalAlign: 'bottom',
            floating: true,
            layout: 'vertical',
            valueDecimals: 0,
            backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || 'rgba(255, 255, 255, 0.85)',
            symbolRadius: 0,
            symbolHeight: 14
          },
          colorAxis: {
            dataClasses: [
              {
                to: 10
              },
              {
                from: 10,
                to: 50
              },
              {
                from: 50,
                to: 100
              },
              {
                from: 100,
                to: 500
              },
              {
                from: 500,
                to: 1000
              },
              {
                from: 1000,
                to: 5000
              },
              {
                from: 5000,
              }
            ]
          },
          series: [
            {
              name: 'Total calls',
              data: data,
              animation: true,
              joinBy: [ 'iso-a2', 'code' ],
              mapData: Highcharts.maps["custom/world-highres"]
            }
          ]
        } );
      } )
    }
  </script>
</head>
<body>
  <div>
    <!-- Type -->
    <label for="type">Type: </label>
    <select id="type">
      <option value="in">In</option>
      <option value="out">Out</option>
    </select>


    <!-- StartDate -->
    <label for="start">Start date: </label><input type="date" id="start">

    <!-- EndDate -->
    <label for="End">end date: </label><input type="date" id="end">

    <!-- Do it button -->
    <button id="doIt">Go!</button>
  </div>
  <hr>
  <div id="map"></div>

  <script>
    var $type = $( '#type' );
    var $start = $( '#start' );
    var $end = $( '#end' );
    var $btn = $( '#doIt' );

    $btn.click( function() {
      var type = $type.val();
      var start = $start.val();
      var end = $end.val();

      drawMap( type, start, end );
    } );


  </script>
</body>
</html>