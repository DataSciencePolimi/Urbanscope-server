{"version":3,"sources":["api/district-tweets.js"],"names":[],"mappings":"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","file":"api/district-tweets.js","sourcesContent":["'use strict';\r\n// Load system modules\r\nimport path from 'path';\r\n\r\n// Load modules\r\nimport moment from 'moment';\r\nimport _ from 'lodash';\r\n\r\n// Load my modules\r\nimport logger from './';\r\nimport { getCollection } from '../model/';\r\n// import nils from '../../config/nils.json';\r\n\r\n// Constant declaration\r\nconst ENDPOINT = path.basename( __filename, '.js' );\r\nconst DATE_FORMAT = 'YYYY-MM-DD';\r\n\r\n// Module variables declaration\r\nlet log = logger.child( { endpoint: ENDPOINT } );\r\n\r\n// Module functions declaration\r\nfunction now() {\r\n  return moment().format( DATE_FORMAT );\r\n}\r\n\r\n// Module class declaration\r\n\r\n// Module initialization (at first load)\r\n\r\n// Entry point\r\n\r\n// Exports\r\nexport default function*() {\r\n  let qs = this.request.query;\r\n  let {\r\n    lang,\r\n    startDate: start,\r\n    endDate: end,\r\n    nil_ID: nil, // jshint ignore: line\r\n  } = qs;\r\n  log.trace( { qs }, 'Query string' );\r\n\r\n  // Default values\r\n  lang = lang || 'it';\r\n  start = start || now();\r\n  end = end || now();\r\n\r\n  lang = lang.toLowerCase();\r\n  start = moment( start, DATE_FORMAT ).startOf( 'day' ).toDate();\r\n  end = moment( end, DATE_FORMAT ).endOf( 'day' ).toDate();\r\n\r\n  log.trace( 'Lang: %s', lang );\r\n  log.trace( 'Start: %s', start );\r\n  log.trace( 'End: %s', end );\r\n  log.trace( 'Nil: %s', nil );\r\n\r\n  let query = {\r\n    source: 'twitter',\r\n    date: {\r\n      $gte: start,\r\n      $lte: end,\r\n    },\r\n  };\r\n\r\n  // Narrow by language\r\n  if( lang==='it' ) {\r\n    query.lang = 'it';\r\n  } else if( lang==='en' ) {\r\n    query.lang = 'en';\r\n  } else if( lang==='other' ) {\r\n    query.lang = {\r\n      $nin: [ 'it', 'en' ],\r\n    };\r\n  }\r\n\r\n  // Narrow by NIL (if present)\r\n  if( nil ) {\r\n    let nilList = nil.split( ',' ).map( nil => Number(nil) );\r\n\r\n    query.nil = {\r\n      $in: nilList,\r\n    };\r\n  }\r\n\r\n\r\n  log.debug( { query }, 'Performing the query' );\r\n  let collection = getCollection();\r\n  let data = yield collection.find( query, 'date lang id nil' );\r\n\r\n  let response = {\r\n    startDate: moment( start ).format( DATE_FORMAT ),\r\n    endDate: moment( end ).format( DATE_FORMAT ),\r\n    lang,\r\n  };\r\n\r\n  response.nils = _( data )\r\n  .groupBy( 'nil' )\r\n  .map( ( tweets, nil ) => {\r\n    let langs = _.countBy( tweets, 'lang' );\r\n    let value = 'To be defined';\r\n    nil = Number( nil ); // Force conversion\r\n\r\n    return {\r\n      langs,\r\n      nil,\r\n      value,\r\n    };\r\n  } )\r\n  .value();\r\n\r\n  this.body = response;\r\n}\r\n\r\n\r\n//  50 6F 77 65 72 65 64  62 79  56 6F 6C 6F 78"],"sourceRoot":"/source/"}