{"version":3,"sources":["api/timeline-tweets.js"],"names":[],"mappings":"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","file":"api/timeline-tweets.js","sourcesContent":["'use strict';\n// Load system modules\nlet path = require( 'path' );\n\n// Load modules\nlet _ = require( 'lodash' );\nlet moment = require( 'moment' );\n\n// Load my modules\nlet logger = require( './' );\nlet getCollection = require( '../model/' ).getCollection;\n\n// Constant declaration\nconst ENDPOINT = path.basename( __filename, '.js' );\nconst DATE_FORMAT = 'YYYY-MM-DD';\n\n// Module variables declaration\nlet log = logger.child( { endpoint: ENDPOINT } );\n\n// Module functions declaration\nfunction now() {\n  return moment().format( DATE_FORMAT );\n}\n\n// Module class declaration\n\n// Module initialization (at first load)\n\n// Entry point\n\n// Exports\nmodule.exports = function* () {\n  let qs = this.request.query;\n  let lang = qs.lang;\n  let start = qs.startDate;\n  let end = qs.endDate;\n  log.trace( { qs: qs }, 'Query string' );\n\n  // Default values\n  lang = lang || 'it';\n  start = start || now();\n  end = end || now();\n\n  lang = lang.toLowerCase();\n  start = moment.utc( start, DATE_FORMAT ).startOf( 'day' ).toDate();\n  end = moment.utc( end, DATE_FORMAT ).endOf( 'day' ).toDate();\n\n  log.trace( 'Lang: %s', lang );\n  log.trace( 'Start: %s', start );\n  log.trace( 'End: %s', end );\n\n  let query = {\n    source: 'twitter',\n    date: {\n      $gte: start,\n      $lte: end,\n    },\n  };\n\n  // Narrow by language\n  if( lang==='it' ) {\n    query.lang = 'it';\n  } else if( lang==='en' ) {\n    query.lang = 'en';\n  } else if( lang==='other' ) {\n    query.lang = {\n      $nin: [ 'it', 'en', 'und' ],\n    };\n  }\n\n  log.debug( { query: query }, 'Performing the query' );\n  let collection = getCollection();\n  let data = yield collection.find( query, 'date lang' );\n\n  let response = {\n    startDate: moment( start ).format( DATE_FORMAT ),\n    endDate: moment( end ).format( DATE_FORMAT ),\n    lang: lang,\n  };\n\n  let timeline = _( data )\n  .groupBy( function( post ) {\n    return moment( post.date ).format( 'YYYY-MM' );\n  } )\n  .map( function( posts, date ) {\n    return {\n      date: date,\n      value: posts.length,\n    };\n  } )\n  .value();\n\n\n\n\n\n  response.timeline = timeline;\n  this.body = response;\n};\n\n\n//  50 6F 77 65 72 65 64  62 79  56 6F 6C 6F 78"],"sourceRoot":"/source/"}