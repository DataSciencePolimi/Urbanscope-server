{"version":3,"sources":["api/top-anomaly.js"],"names":[],"mappings":"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","file":"api/top-anomaly.js","sourcesContent":["'use strict';\n// Load system modules\nimport path from 'path';\n\n// Load modules\nimport _ from 'lodash';\nimport moment from 'moment';\n\n// Load my modules\nimport logger from './';\nimport { getCollection } from '../model/';\nimport { getNilAnomalies, NILS_TO_USE } from '../utils/anomalies';\n\n// Constant declaration\nconst ENDPOINT = path.basename( __filename, '.js' );\nconst DATE_FORMAT = 'YYYY-MM-DD';\n\n// Module variables declaration\nlet log = logger.child( { endpoint: ENDPOINT } );\n\n// Module functions declaration\nfunction now() {\n  return moment().format( DATE_FORMAT );\n}\n\n\n// Module class declaration\n\n// Module initialization (at first load)\n\n// Entry point\n\n// Exports\nexport default function*() {\n  let qs = this.request.query;\n  let {\n    lang,\n    startDate: start,\n    endDate: end,\n    limit,\n  } = qs;\n  log.trace( { qs }, 'Query string' );\n\n  // Default values\n  limit = limit || 3;\n  lang = lang || 'it';\n  start = start || now();\n  end = end || now();\n\n  lang = lang.toLowerCase();\n  start = moment.utc( start, DATE_FORMAT ).startOf( 'day' ).toDate();\n  end = moment.utc( end, DATE_FORMAT ).endOf( 'day' ).toDate();\n\n  log.trace( 'Lang: %s', lang );\n  log.trace( 'Limit: %d', limit );\n  log.trace( 'Start: %s', start );\n  log.trace( 'End: %s', end );\n\n  let query = {\n    source: 'twitter',\n    date: {\n      $gte: start,\n      $lte: end,\n    },\n  };\n\n  // Narrow by language\n  query.lang = {\n    $ne: 'und',\n  };\n\n  query.nil = {\n    $in: NILS_TO_USE,\n  };\n\n  log.debug( { query }, 'Performing the query' );\n  let collection = getCollection();\n  let data = yield collection.find( query, 'lang nil' );\n\n\n  let response = {\n    startDate: moment( start ).format( DATE_FORMAT ),\n    endDate: moment( end ).format( DATE_FORMAT ),\n    lang: lang,\n  };\n\n\n  let top = getNilAnomalies( data, lang );\n\n  response.top = _( top )\n  .sortByOrder( 'value', false )\n  .take( limit )\n  .value();\n\n  this.body = response;\n}\n\n\n//  50 6F 77 65 72 65 64  62 79  56 6F 6C 6F 78"],"sourceRoot":"/source/"}